Option Explicit
Public Sub Correct()
Selecter.Show
End Sub
Public Sub Corecter(ByVal Sel As Boolean)
Application.ScreenUpdating = False
Application.DisplayAlerts = False
Dim buf As String, myRec As String, myStr() As String, dataPlayed As String, mm As String
Dim FileNum As Long, FileRow As Long, maxCol As Long
Dim i As Long, n As Long
Dim FS0 As Object
Dim csvArray() As Variant
'引数処理
buf = Environ("FILE")

'CSVの読み込みと書き出し処理

Set FS0 = CreateObject("Scripting.FileSystemObject")

With FS0.OpenTextFile(buf, 8)
    FileRow = .Line
    .Close
End With

Set FS0 = Nothing
FileNum = FreeFile
i = 0
maxCol = 0

Open buf For Input As #FileNum
    
    Do While Not EOF(FileNum)
        Line Input #FileNum, myRec
        myStr = Split(myRec, ",")
        If maxCol < UBound(myStr) Then maxCol = UBound(myStr)
        ReDim Preserve csvArray(0 To FileRow, 0 To maxCol)
        csvArray(i, 0) = myStr(5)
        csvArray(i, 1) = myStr(6)
        csvArray(i, 2) = myStr(8)
        i = i + 1
    Loop
    
    Range(Cells(1, 1), Cells(FileRow + 1, maxCol + 1)) = csvArray
    
Close #FileNum

'時間が接続されて文字列になっている日付を矯正する
Columns("B:B").NumberFormatLocal = "yyyy/m/d"
If Sel = False Then
    Range("A:C").Sort key1:=Range("C1"), Order1:=xlDescending, key2:=Range("B1"), order2:=xlDescending, Header:=xlYes
    dataPlayed = "Max"
ElseIf Sel = True Then
    Range("A:C").Sort key1:=Range("C1"), Order1:=xlDescending, key2:=Range("B1"), order2:=xlAscending, Header:=xlYes
    dataPlayed = "Min"
End If

Columns("A:C").RemoveDuplicates 1, xlYes
Range("A:C").Sort key1:=Range("A1"), Order1:=xlAscending, Header:=xlYes

mm = Month(Application.WorksheetFunction.Max(Range("B:B")))

Columns("A:C").AutoFit
'出力したファイルを使用者のPCに保存する
Application.ScreenUpdating = True
ThisWorkbook.SaveAs Filename:=Environ("FILEDIR") & "【加工後】" & mm & "月MAUレポート(" & dataPlayed & ").xlsx", FileFormat:=xlOpenXMLWorkbook
Application.DisplayAlerts = True
Range("A1").Select

End Sub

